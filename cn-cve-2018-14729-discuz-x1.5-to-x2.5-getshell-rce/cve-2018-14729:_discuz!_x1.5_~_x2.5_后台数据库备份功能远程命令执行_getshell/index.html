<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Ambulong">
<meta name="description" content="Discuz! X1.5 to X2.5 数据库备份功能文件 source/admincp/admincp_db.php 存在命令注入漏洞，允许攻击者通过该漏洞执行任意系统命令。">
<meta name="keywords" content="CVE-2018-14729,2018-14729,discuz,dz,dz2.5,discuz 2.5,rce,getshell,后台,提权,代码执行,rce,利用,复现,演示,exp,exploit,security,practict,在线靶场,黑客技术,网络安全,信息安全,漏洞测试,CTF在线,渗透测试,在线练习,演练,实验,pentest,online">
<title>CVE-2018-14729: Discuz! X1.5 ~ X2.5 后台数据库备份功能远程命令执行 Getshell | VULNSPY</title>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<script src="/js/jquery-1.11.3.min.js"></script>
<script src="/js/jquery-migrate-1.2.1.min.js"></script>
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/ie10-viewport-bug-workaround.css" rel="stylesheet">
<!--[if lt IE 9]><script src="/js/ie8-responsive-file-warning.js"></script><![endif]-->
<script src="/js/ie-emulation-modes-warning.js"></script>
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<script src="/js/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="/js/ie10-viewport-bug-workaround.js"></script>
<link rel="stylesheet" href="/css/custom.css" />
<link rel="stylesheet" href="/css/prism.css" />
<script src="/js/functions.js"></script>
<script src="/js/custom.js"></script>
<script>
function GetQueryString(name)
{
     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
     var r = window.location.search.substr(1).match(reg);
     if(r!=null)return  unescape(r[2]); return null;
}
var lang="en";
var la=(navigator.language) ? navigator.language.toLowerCase() : navigator.userLanguage.toLowerCase();
if(la=='zh-cn' || la=='zh-tw' || la=='zh-hk'){
	lang="cn";
}
</script>
<!--[if lt IE 9]>
	<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
<![endif]-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-108901411-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108901411-2');
</script>
</head>
<body>
<div class="view-header" style="z-index: 999;">
    <ul>
    	<li><a href="/"><h1><img style="width:1.5em;height: auto;margin-top: -0.3em;" src="/images/owl2.png" /></h1></a></li>
        <li ><a href="/">VULNSPY</a></li>
        <li><a href="https://blog.vulnspy.com/">BlOG</a></li>
        <div class="pull-right">
            <li><a target="_blank" href="https://www.reddit.com/r/jiuwu/">REDDIT</a></li>
            <li><a target="_blank" href="https://www.youtube.com/channel/UCnqjUDkrZ0OFwZvxxiC47gw">YOUTUBE CHANNEL</a></li>
        </div>
    </ul>
</div>
<style>
.main{
	
	margin: 0 auto;
	margin-top: 7em;
	max-width: 90em;
	width: 95%;
}
.lab{
	float:left;
	width: 77%;
}
.lab h1{
	padding: 0;
	font-size: 230%;
	margin: 20px 0;
	line-height: 1.5em;
}

.lab .demo{
	font-size: 115%;
	line-height: 2em;
	border: 1px solid #ccc;
	background: #2C3844;
	margin: 1.8em 0 1em 0;
}
.lab .demo .demo-btn{
	text-align: center;
	font-size: 150%;
	margin: 0.3em 0;
	color: #FFF;
}
.lab .demo .demo-btn a{
	background: transparent;
	padding: 1em;
	font-size: 100%;
	display: block;
	
}
.lab .demo .demo-link{
	background: rgba(0,0,0,.25);
}
.lab .demo a{
	font-size: 50%;
	text-transform: uppercase;
	padding: 0 0.5em;
	color: #FFF;
}
.lab .content{
	font-size: 130%;
	line-height: 1.5em;
}
.lab .content p{
	margin: 1em 0;
}
.lab .content img{
	max-width: 100%;
	margin: 1em 0;
}
.sidebar{
	width: 23%;
	float: left;
	padding-left: 2em;
	margin-top: 20px;
}
.sidebar .sth-btn {
	width: 100%;
	margin-left: 1em;
}
#sth {
	display: block;
	text-align: center;
	text-transform: uppercase;
	padding: 0.8em 1em;
	font-size:123%;
	border: none;
	border-radius: 0;
	background: #337ab7;
	color: #FFF;
	font-weight: bold;
}
#demo-notice {
	width: 100%;
	margin: 0.8em 0;
	font-size: 90%;
	text-align: center;
	color: #777;
	word-break:break-all;
}
.sidebar ul{
	margin: 2em 0;
	padding: 0;
}
.sidebar ul ul{
	margin: 0;
	margin-left: 1em;
}
.sidebar li{
	margin: 0 0 0.5em 0;
	font-size: 110%;
	list-style: none;
	color: #767676;
	border-left: solid 0.1em #FFF;
	padding-left: 1em;
	margin-left: 1em;
	cursor: pointer;
}
.sidebar li.selected{
	color: #2C3844;
	border-left: solid 0.1em #2C3844;
}
.sidebar li:hover{
	color: #2C3844;
	border-left: solid 0.1em #2C3844;
}
</style>
<div class="main">
	<div class="lab">
		<h1>CVE-2018-14729: Discuz! X1.5 ~ X2.5 后台数据库备份功能远程命令执行 Getshell</h1>
		<hr/>
		<div class="content"><blockquote>
<ul>
<li>本文作者：Lucifaer</li>
<li>发现漏洞白帽：MitAh@Chaitin Tech</li>
<li>转载自: <a href="https://www.anquanke.com/post/id/158270">https://www.anquanke.com/post/id/158270</a></li>
</ul>
</blockquote>
<h3>0x00 漏洞简述</h3>
<h4>漏洞信息</h4>
<p>8月27号有人在GitHub上公布了有关Discuz 1.5-2.5版本中后台数据库备份功能存在的命令执行漏洞的细节。</p>
<h4>漏洞影响版本</h4>
<p>Discuz! 1.5-2.5</p>
<h3>0x01 漏洞复现</h3>
<p>官方论坛下载相应版本就好。</p>
<h3>0x02 漏洞分析</h3>
<p>需要注意的是这个漏洞其实是需要登录后台的，并且能有数据库备份权限，所以比较鸡肋。</p>
<p>我这边是用Discuz! 2.5完成漏洞复现的，并用此进行漏洞分析的。</p>
<p>漏洞点在：</p>
<pre><code class="language-bash">source/admincp/admincp_db.php</code></pre>
<p>第296行：</p>
<pre><code class="language-php">@shell_exec($mysqlbin.'mysqldump --force --quick '.($db-&gt;version() &gt; '4.1' ? '--skip-opt --create-options' : '-all').' --add-drop-table'.($_GET['extendins'] == 1 ? ' --extended-insert' : '').''.($db-&gt;version() &gt; '4.1' &amp;&amp; $_GET['sqlcompat'] == 'MYSQL40' ? ' --compatible=mysql40' : '').' --host="'.$dbhost.($dbport ? (is_numeric($dbport) ? ' --port='.$dbport : ' --socket="'.$dbport.'"') : '').'" --user="'.$dbuser.'" --password="'.$dbpw.'" "'.$dbname.'" '.$tablesstr.' &gt; '.$dumpfile);</code></pre>
<p>在shell_exec()函数中可控点在$tablesstr，向上看到第281行：</p>
<pre><code class="language-php">$tablesstr = '';
foreach($tables as $table) {
    $tablesstr .= '"'.$table.'" ';
}</code></pre>
<p>跟一下$table的获取流程，在上面的第143行：</p>
<pre><code class="language-php">if($_GET['type'] == 'discuz' || $_GET['type'] == 'discuz_uc') 
{
    $tables = arraykeys2(fetchtablelist($tablepre), 'Name');
} 
elseif($_GET['type'] == 'custom') 
{
    $tables = array();
    if(empty($_GET['setup'])) 
    {
        $tables = C::t('common_setting')-&gt;fetch('custombackup', true);
    } 
    else 
    {
        C::t('common_setting')-&gt;update('custombackup', empty($_GET['customtables'])? '' : $_GET['customtables']);
        $tables = &amp; $_GET['customtables'];
    }
    if( !is_array($tables) || empty($tables)) 
    {
        cpmsg('database_export_custom_invalid', '', 'error');
    }
}</code></pre>
<p>可以看到：</p>
<pre><code class="language-php">C::t('common_setting')-&gt;update('custombackup', empty($_GET['customtables'])? '' : $_GET['customtables']);
$tables = &amp; $_GET['customtables'];</code></pre>
<p>首先会从$_GET的数组中获取customtables字段的内容，判断内容是否为空，不为空则将从外部获取到的customtables字段内容写入common_setting表的skey=custombackup的svalue字段，写入过程中会将这个字段做序列化存储：</p>
<p><img src="/images/cn-cve-2018-14729-discuz-x1.5-to-x2.5-getshell-rce/t018398d32cd00241b1.jpg" alt="" /></p>
<p>之后再将该值赋给$tables。</p>
<p>至此可以看到漏洞产生的原因是由于shell_exec()中的$tablesstr可控，导致代码注入。</p>
<h3>0x03 漏洞利用</h3>
<p>漏洞的调用栈如下：</p>
<p><code>admin.php-&gt;source/class/discuz/discuz_admincp.php-&gt;source/admincp/admincp_db.php</code></p>
<p>跟着漏洞的调用栈看一下如何利用。</p>
<p>首先在admin.php中：</p>
<pre><code class="language-php">if(empty($action) || $frames != null) {
    $admincp-&gt;show_admincp_main();
} elseif($action == 'logout') {
    $admincp-&gt;do_admin_logout();
    dheader("Location: ./index.php");
} elseif(in_array($action, $admincp_actions_normal) || ($admincp-&gt;isfounder &amp;&amp; in_array($action, $admincp_actions_founder))) {
    if($admincp-&gt;allow($action, $operation, $do) || $action == 'index') {
        require $admincp-&gt;admincpfile($action);
    } else {
        cpheader();
        cpmsg('action_noaccess', '', 'error');
    }
} else {
    cpheader();
    cpmsg('action_noaccess', '', 'error');
}</code></pre>
<p>关键点在构造参数满足<code>require $admincp-&gt;admincpfile($action);</code>且<code>$action</code>为<code>db</code>。也就说需要构造参数满足：</p>
<pre><code class="language-php">$admincp-&gt;isfounder &amp;&amp; in_array($action, $admincp_actions_founder) # 为真

$admincp-&gt;allow($action, $operation, $do) # 为真
$admincp-&gt;isfounder是确认当前用户的，返回为True，这里只需要构造$action为db。</code></pre>
<p>跟进<code>require $admincp-&gt;admincpfile($action);</code>：</p>
<pre><code class="language-php">function admincpfile($action) {
        return './source/admincp/admincp_'.$action.'.php';
}</code></pre>
<p>这里就包含了<code>source/admincp/admincp_db.php</code>。跟进看一下：</p>
<p><img src="/images/cn-cve-2018-14729-discuz-x1.5-to-x2.5-getshell-rce/t010f8277ef7a2aea9f.jpg" alt="" /></p>
<p>这边需要满足$operation == ‘export’，同时存在exportsubmit字段。</p>
<p>之后，</p>
<p><img src="/images/cn-cve-2018-14729-discuz-x1.5-to-x2.5-getshell-rce/t01ad49532e8afc9c45.jpg" alt="" /></p>
<p>需要构造file字段，同时$_GET[‘type’] == ‘custom’且$_GET[‘setup’]和$_GET[‘customtables’]非空。向下跟，还需要满足最后一个条件$_GET[‘method’] != ‘multivol’，这样才能调用else中的操作，完成代码注入。</p>
<p>有了上面的这些基础分析，我们抓个符合上方条件的包来看一下。经过测试，</p>
<p><img src="/images/cn-cve-2018-14729-discuz-x1.5-to-x2.5-getshell-rce/t017bd4d6169f9c630f.jpg" alt="" /></p>
<p>这样可以抓到符合我们条件的请求包。</p>
<p><img src="/images/cn-cve-2018-14729-discuz-x1.5-to-x2.5-getshell-rce/t01c83f25102c3fdeae.jpg" alt="" /></p>
<p>接下来只需要将customtables的内容更改一下就可以造成命令执行了：</p>
<p><img src="/images/cn-cve-2018-14729-discuz-x1.5-to-x2.5-getshell-rce/t019aa5779beac370ea.jpg" alt="" /></p>
<p><img src="/images/cn-cve-2018-14729-discuz-x1.5-to-x2.5-getshell-rce/t01d51f2e4196664934.jpg" alt="" /></p>
<p>效果为：</p>
<p><img src="/images/cn-cve-2018-14729-discuz-x1.5-to-x2.5-getshell-rce/t0153536e90011b8796.jpg" alt="" /></p>
<h3>0x04 参数获取问题</h3>
<p>通过上面的分析可以看到最终可控参数的获取都是利用$_GET来获取的，但是我们在构造时发送的是post数据，那么为什么会照常获取到呢？</p>
<p>在admin.php第18行包含了source/class/class_core.php：跟进看一下：</p>
<pre><code class="language-php">...
C::creatapp();

class core
{
...
    public static function creatapp() {
    if(!is_object(self::$_app)) {
        self::$_app = discuz_application::instance();
    }
    return self::$_app;
}
...
}</code></pre>
<p>跟进到source/class/discuz/discuz_application.php中：</p>
<pre><code class="language-php">public function __construct() {
        $this-&gt;_init_env();
        $this-&gt;_init_config();
        $this-&gt;_init_input();
        $this-&gt;_init_output();
}</code></pre>
<p>接着跟进到_init_input()中：</p>
<pre><code class="language-php">...
if($_SERVER['REQUEST_METHOD'] == 'POST' &amp;&amp; !empty($_POST)) {
            $_GET = array_merge($_GET, $_POST);
        }
...</code></pre>
<p>可以看到如果构造了post请求，Discuz的核心类会将$_GET和$_POST这两个list拼接到一起，赋给$_GET数组。</p>
<h3>0x05 修复方法</h3>
<p>可以利用addslashes()对可控点进行限制，同时利用escapeshellarg()函数来限制$tablesstr执行命令。</p>
<h3>0x06 Discuz 3.4的做法</h3>
<p>Discuz 3.4非常有趣的一点不是把这个漏洞修了，而是直接在source/admincp/admincp_db.php第307行写了一个错误…：</p>
<p>list(, $mysql_base) = DB::fetch($query, DB::$drivertype == 'mysqli' ? MYSQLI_NUM : MYSQL_NUM);
调用了一个未声明的静态变量，所以该功能直接是挂掉的，没有办法使用，可谓是简单粗暴…</p>
<h3>REFERENCE</h3>
<ul>
<li><a href="https://github.com/FoolMitAh/CVE-2018-14729/blob/master/Discuz_backend_getshell.md">FoolMitAh/CVE-2018-14729/Discuz_backend_getshell.md</a></li>
</ul></div>
	</div>
	<div class="sidebar">
		<div class="sth-btn">
			<a id="sth" target="_blank" href="https://www.vsplate.com/?github=vulnspy/Discuz_X2.5_SC_UTF8&amp;autogo=1">start to hack</a>
			<p id="demo-notice">Click the button and start the playing.</p>
		</div>
		<ul>
			<li href="#" class="nlink selected"># TOP</li>
		</ul>
	</div>
</div>
<script>
if(lang == 'cn'){
	$("#demo-notice").html("点击上方按钮开启实验.");
}
$(document).ready(function(){

$.extend({
	genMenu: function() {
		var html = '';
		var prevH = 'h0';
		var toClose = 0;
		$(".content").children("h1,h2,h3,h4,h5").each(function(i,e){
			var tagName = $(e)[0].tagName.toLowerCase();
			//var menuName = 'M-'+window.btoa($(e).text());
			var menuName = 'M-'+randomString(6)+'-'+$(e).text().replace(/\ +/g,"-");
			$(e).attr('id',menuName);
			if(tagName > prevH){
				html = html+'<ul>';
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
				toClose = toClose + 1;
			}else if(tagName == prevH){
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
			}else if(tagName < prevH){
				html = html+'</ul>';
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
				toClose = toClose - 1;
			}
			prevH = tagName;
		});
		while(toClose > 0){
			html = html+'</ul>';
			toClose = toClose - 1;
		}
		$(".sidebar ul").remove();
		$(".sidebar").append(html);
		$(".sidebar ul:first").prepend('<li class="menu-item nlink selected" href="#"># TOP</li>');
		return html;
	}
});
$.extend({
	selectMenu: function() {
		var mintoTop = 20;
		var menu = [];
		$("li.menu-item").each(function(i,e){
			id = $(e);
			if(id && id != '#'){
				menu.push(id);
			}
		});
		for(var i=menu.length;i>0;i--){
			mid = menu[i-1].attr('href');
			var toTop = $(mid).offset().top-$(document).scrollTop();
			if(toTop <= mintoTop){
				$("li.menu-item").removeClass('selected');
				menu[i-1].addClass('selected');
				break;
			}
		}
		return mid;
	}
});
$.extend({
	fixSidebar: function() {
		var sidebarTop = $(".sidebar").offset().top-$(document).scrollTop();
		if($(document).scrollTop() < 120){
			$(".sidebar").css("margin-top", "20px");
		}else if(sidebarTop < 20){
			$(".sidebar").css("margin-top", ($(document).scrollTop()-80)+"px");
		}else if(sidebarTop > 20 && $(document).scrollTop() > 120){
			$(".sidebar").css("margin-top", ($(document).scrollTop()-80)+"px");
		}
	}
});
$.genMenu();
$(window).scroll(function(){
	$.fixSidebar();
	$.selectMenu();
});

});
</script>
<div style="float:left;width:100%;text-align:center;margin-top:5em;background: #000;color: #FFF;">
	<div style="margin:0 auto;width:95%;max-width:90em;padding:1em 0;">All rights reserved. &copy; 2018 VULNSPY</div>
</div>
<script>
$(function () {
	$("pre code").closest("pre").addClass("line-numbers ");
});
</script>
<script src="/js/prism.js"></script>
</body>
</html>
